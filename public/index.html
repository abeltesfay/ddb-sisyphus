<!DOCTYPE html>
<html>
    <head>
        <title>DynamoDB Table Designer</title>
        <link rel="shortcut icon" href="#">
        <style>
            .hidden { display: none; }

            .action-bar {
                border: 1pt solid grey;
                border-radius: 5px;
                margin: .5em .5em 0;
                padding: .5em;
            }

            .action-bar button {
                cursor: pointer;
                padding: .5em 1em;
                min-width: 6em;
            }

            .tableContent button { 
                cursor: pointer;
                padding: .25em .5em;
                min-width: 3em;
            }

            .facets, .fields {
                border: 1pt solid grey;
                border-radius: 5px;
                float: left;
                margin: .5em;
                padding: 0 1em;
                width: 20%;
            }

            .facets li, .fields li { cursor: pointer; }
            
            .highlightedfacet, .highlightedfield { font-weight: bold };
        </style>
        <!-- <meta http-equiv="refresh" content="5" > -->
        <script type="text/javascript">
            const CONSTS = {
                LSKEY: "SISYPHUS_DATA",
            };

            let APP_STATE = { facets: [] };
            
            let selectedFacet = undefined, selectedField = undefined;

            function preparePage() {
                console.debug("PREP: Preparing page and buttons");
                
                loadAppState();
                redrawPage();
                setClick("saveState", saveAppState);
                setClick("nukeFromOrbit", nukeFromOrbit);
                setClick("addFacet", addFacet);
                setClick("addField", addField);
                setClick("editFacetName", editFacetName);
                setClick("editFieldName", editFieldName);
                
                console.debug("PREP: Finished prep");
            }

            function setClick(id, fn) {
                if (document.getElementById(id)) { document.getElementById(id).onclick = fn; }
            }

            function redrawPage() {
                redrawFacets();
                redrawFields();
            }

            function redrawFacets() {
                const facetListEle = document.getElementById("facetList");
                Array.from(facetList.getElementsByTagName("li")).forEach(o => o.remove())
                
                let facetNames = APP_STATE?.facets?.map(facet => facet.name);
                
                facetNames?.forEach(facet => {
                    let facetEle = document.createElement("li");
                    facetEle.innerText = facet;
                    facetEle.dataset.name = facet;
                    facetEle.onclick = selectFacet.bind(facetEle);
                    facetListEle.appendChild(facetEle);

                    if (selectedFacet == facet) {
                        facetEle.classList.add("highlightedfacet");
                    }
                });

                document.getElementById("editFacetName").disabled = !selectedFacet;
            }

            function redrawFields() {
                const fieldListEle = document.getElementById("fieldList");
                Array.from(fieldListEle.getElementsByTagName("li")).forEach(o => o.remove())
                if (!selectedFacet) { return; }
                
                // let fieldNames = APP_STATE?.facets?.fieldsmap(field => facet.name);
                let fieldNames = getFacetByName(selectedFacet).fields ?? [];
                
                fieldNames?.forEach(field => {
                    let fieldEle = document.createElement("li");
                    fieldEle.innerText = field;
                    fieldEle.dataset.name = field;
                    fieldEle.onclick = selectField.bind(fieldEle);
                    fieldListEle.appendChild(fieldEle);

                    if (selectedField == field) {
                        fieldEle.classList.add("highlightedfield");
                    }
                });

                document.getElementById("editFieldName").disabled = !selectedField;
            }

            function getFacetByName(name) {
                return APP_STATE.facets[APP_STATE.facets.findIndex(facet => facet.name == name)];
            }

            function addFacet() {
                const name = prompt("Please provide a new, unique facet name")?.trim();
                if (!name) { return; }

                if (APP_STATE.facets.map(o => o.name).includes(name)) {
                    alert("This name already exists, please choose another");
                    return;
                }
                
                APP_STATE.facets.push({ name });
                setSavedFlag(false);
                redrawPage();

                console.debug("ADDFACET: New facet added:", name);
            }

            function addField() {
                if (!selectedFacet) { alert("Please select a facet first"); return; }

                const facet = getFacetByName(selectedFacet);
                const name = prompt("Please provide a new field name")?.trim();
                if (!name) { return; }
                if (facet?.fields?.includes?.(name)) { alert("Facet already contains this field"); return; }
                if (!Array.isArray(facet?.fields)) { facet.fields = []; }
                facet.fields.push(name);

                // TODO Order fields
                
                setSavedFlag(false);
                redrawPage();
            }

            function selectFacet() {
                selectedFacet = this.innerText;
                selectedField = undefined;
                redrawPage();
            }

            function editFacetName() {
                if (!selectedFacet) { return; }
                console.debug(`EDITFACET: Editing facet name from ${selectedFacet}`);

                const name = prompt("Please provide a new, unique facet name")?.trim();
                if (!name) { return; }

                if (APP_STATE.facets.map(o => o.name).includes(name)) {
                    alert("This name already exists, please choose another");
                    return;
                }
                
                const oldFacetName = selectedFacet;
                let facet = getFacetByName(oldFacetName);
                facet.name = name;
                setSavedFlag(false);
                selectedFacet = name;
                redrawPage();

                console.debug(`EDITFACET: Facet name updated from ${oldFacetName} to ${name}`);
            }

            function editFieldName() {
                if (!selectedFacet || !selectedField) { return; }
                console.debug(`EDITFIELD: Editing facet and field name from ${selectedFacet}.${selectedField}`);

                const name = prompt("Please provide a new field name")?.trim();
                let facet = getFacetByName(selectedFacet);
                if (!name ) { return; }
                if (facet?.fields?.includes?.(name)) { alert("Facet already contains this field"); return; }

                let index  = facet.fields.findIndex(field => field == selectField);
                facet.fields = facet.fields.filter(field => field !== selectedField);
                facet.fields.push(name);

                const oldFieldName = selectedField;
                selectedField = name;
                setSavedFlag(false);
                redrawPage();
                
                console.debug(`EDITFACET: Field name updated from ${selectedFacet}.${oldFieldName} to ${selectedFacet}.${name}`);
            }

            function selectField() {
                selectedField = this.innerText;
                redrawPage();
            }

            function deleteFacet() {
                if (!confirm("Are you SURE you want to delete this facet?")) { return; }
                const name = this.innerText;
                const oldCount = APP_STATE.facets.length;
                APP_STATE.facets = APP_STATE.facets.filter(facet => facet.name !== this.innerText);
                const newCount = APP_STATE.facets.length;
                setSavedFlag(oldCount === newCount);
                redrawPage()
                console.warn(`DELETEFACET: Removed a facet: ${name}. Old count=[${oldCount}], new count=[${newCount}]`);
            }

            function saveAppState() {
                console.debug("SAVEAPP: Saving application state");
                const dataAsString = JSON.stringify(APP_STATE);
                window.localStorage.setItem(CONSTS.LSKEY, dataAsString);
                setSavedFlag(true);
                console.log(`SAVEAPP: Data saved to localStorage key=[${CONSTS.LSKEY}]`);
            }
            
            function nukeFromOrbit() {
                console.warn("NUKEFROMORBIT: Confirming user is crazy");
                if (!confirm("Are you sure you want to delete all of app state?")) { return; }
                
                console.warn("NUKEFROMORBIT: Nuking from orbit, hold on to your butts");
                window.localStorage.removeItem(CONSTS.LSKEY);
                console.warn("NUKEFROMORBIT: Target is cleared");
                location.reload();
            }

            function loadAppState() {
                console.debug("LOADAPP: Loading application from local storage")
                const data = window.localStorage.getItem(CONSTS.LSKEY);
                APP_STATE = JSON.parse(data) ?? getDefaultAppState();
                console.debug(`LOADAPP: Application loaded from state, facets loaded: ${APP_STATE?.facets?.length ?? 0}`)
            }

            function getDefaultAppState() { return { facets: [] }; };

            function toggleUnsavedData() {
                const isVisible = !document.getElementById("#unsaved").classList.contains("hidden");
                if (isVisible) {
                    document.getElementById("#unsaved").classList.push("hidden");
                } else {
                    document.getElementById("#unsaved").classList.remove("hidden");
                }
            }

            function setSavedFlag(isSaved) {
                const isVisible = !document.getElementById("unsaved").classList.contains("hidden");
                if (isSaved && isVisible) {
                    document.getElementById("unsaved").classList.add("hidden");
                } else if (!isSaved && !isVisible) {
                    document.getElementById("unsaved").classList.remove("hidden");
                }
            }

            function processKeys(event) {
                // Deselect facet
                if (event.key === "Escape") {
                    selectedFacet = null;
                    selectedField = null;
                    redrawPage();
                };
            }
        </script>
    </head>
    <body onkeydown="processKeys(event);" onload="preparePage();">
        <div class="action-bar">
            <button id="saveState">Save</button>
            <button id="nukeFromOrbit">Nuke State</button>
            <div class="hidden" id="unsaved">
                <br>
                <label>Unsaved data</label>
            </div>
        </div>
        <div class="tableContent">
            <div class="facets">
                <h2>Facets</h2>
                <button id="addFacet" value="Add">Add</button>
                <button disabled id="editFacetName" value="Edit">Edit</button>
                <ol id="facetList">
                </ol>
            </div>
            <div class="fields">
                <h2>Fields</h2>
                <button id="addField" value="Add">Add</button>
                <button disabled id="editFieldName" value="Edit">Edit</button>
                <ol id="fieldList">
                </ol>
            </div>
            <div></div>
        </div>
    </body>
</html>