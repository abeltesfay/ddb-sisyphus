<!DOCTYPE html>
<html>
    <head>
        <title>DynamoDB Table Designer</title>
        <link rel="shortcut icon" href="#">
        <style>
            .hidden { display: none; }

            .action-bar {
                border: 1pt solid grey;
                border-radius: 5px;
                margin: .5em .5em 0;
                padding: .5em;
            }

            .action-bar button {
                cursor: pointer;
                padding: .5em 1em;
                min-width: 6em;
            }

            .tableContent button { 
                cursor: pointer;
                padding: .25em .5em;
                min-width: 3em;
            }

            .facets, .fields {
                border: 1pt solid grey;
                border-radius: 5px;
                float: left;
                margin: .5em;
                padding: 0 1em;
                /* width: 20%; */
            }

            .facets li, .fields li {
                cursor: pointer;
                position: relative;
            }

            .fields span {
                /* min-width: 70%; */
                display: inline-block;
                margin-right: 1em;
            }

            .fields select.spacefiller { visibility: hidden; }

            .fields select.floater {
                position: absolute;
                right: 0;
            }
            
            .highlightedfacet, .highlightedfield { font-weight: bold };
        </style>
        <!-- <meta http-equiv="refresh" content="5" > -->
        <script type="text/javascript">
            const CONSTS = {
                LSKEY: "SISYPHUS_DATA",
            };

            let APP_STATE = { facets: [] };
            let APP_STATE_SAVED = undefined;
            
            let selectedFacet = undefined, selectedField = undefined;

            function preparePage() {
                console.debug("PREP: Preparing page and buttons");
                
                loadAppState();
                redrawPage();
                setClick("saveState", saveAppState);
                setClick("loadFromOrbit", loadFromOrbit);
                setClick("nukeFromOrbit", nukeFromOrbit);
                setClick("logState", logState);
                setClick("addFacet", addFacet);
                setClick("addField", addField);
                setClick("editFacetName", editFacetName);
                setClick("editFieldName", editFieldName);
                setClick("deleteFacet", deleteFacet);
                setClick("deleteField", deleteField);
                
                console.debug("PREP: Finished prep");
            }

            function clone(o) { return JSON.parse(JSON.stringify(o)); }

            function setClick(id, fn) {
                if (document.getElementById(id)) { document.getElementById(id).onclick = fn; }
            }

            function redrawPage() {
                checkSavedState();
                redrawFacets();
                redrawFields();
            }

            function checkSavedState() {
                // console.debug("CHECKSTATE: Checking saved state");
                const unchanged = JSON.stringify(APP_STATE) === JSON.stringify(APP_STATE_SAVED);
                setSavedFlag(unchanged);
                // console.debug(`CHECKSTATE: Unchanged = ${unchanged}`);
            }

            function redrawFacets() {
                const facetListEle = document.getElementById("facetList");
                Array.from(facetList.getElementsByTagName("li")).forEach(o => o.remove())
                document.getElementById("editFacetName").disabled = !selectedFacet;
                document.getElementById("deleteFacet").disabled = !selectedFacet;
                
                let facetNames = APP_STATE?.facets?.map(facet => facet.name);
                
                facetNames?.forEach(facet => {
                    let facetEle = document.createElement("li");
                    facetEle.innerText = facet;
                    facetEle.dataset.name = facet;
                    facetEle.onclick = selectFacet.bind(facetEle);
                    facetListEle.appendChild(facetEle);

                    if (selectedFacet == facet) {
                        facetEle.classList.add("highlightedfacet");
                    }
                });

                document.getElementById("editFacetName").disabled = !selectedFacet;
                document.getElementById("deleteFacet").disabled = !selectedFacet;
            }

            function redrawFields() {
                const fieldListEle = document.getElementById("fieldList");
                Array.from(fieldListEle.getElementsByTagName("li")).forEach(o => o.remove())
                document.getElementById("editFieldName").disabled = !selectedField;
                document.getElementById("deleteField").disabled = !selectedField;

                if (!selectedFacet) { redrawAllFields(); return; }
                
                let fields = getFacetByName(selectedFacet).fields ?? [];
                
                fields?.forEach(field => {
                    let fieldEle = document.createElement("li");
                    let fieldLabelEle = document.createElement("span");
                    // fieldText = `${field}`;
                    // fieldLabelEle.innerText = fieldText;
                    fieldLabelEle.innerText = field.name;
                    fieldLabelEle.dataset.name = field.name;
                    fieldLabelEle.dataset.facet = selectedFacet;
                    fieldLabelEle.onclick = selectField.bind(fieldLabelEle);
                    fieldEle.appendChild(fieldLabelEle);
                    fieldListEle.appendChild(fieldEle);

                    let fieldTypeDropdownEle = getDropdownElement(selectedFacet, field.name);
                    let fieldTypeDropdownEleFiller = fieldTypeDropdownEle.cloneNode(true);
                    fieldTypeDropdownEle.classList.add("floater");
                    fieldEle.appendChild(fieldTypeDropdownEle);
                    
                    fieldTypeDropdownEleFiller.classList.add("spacefiller");
                    fieldEle.appendChild(fieldTypeDropdownEleFiller);

                    if (selectedField == field.name) {
                        fieldEle.classList.add("highlightedfield");
                    }
                });
            }

            function redrawAllFields() {
                const fieldListEle = document.getElementById("fieldList");
                
                APP_STATE.facets.forEach(facet => {
                    facet.fields.forEach(field => {
                        let fieldEle = document.createElement("li");
                        let fieldLabelEle = document.createElement("span");
                        fieldText = `${facet.name}.${field.name}`;
                        fieldLabelEle.innerText = fieldText;
                        fieldLabelEle.dataset.name = field;
                        fieldLabelEle.dataset.facet = facet.name;
                        fieldLabelEle.onclick = selectField.bind(fieldLabelEle);
                        fieldEle.appendChild(fieldLabelEle);
                        fieldListEle.appendChild(fieldEle);

                        let fieldTypeDropdownEle = getDropdownElement(facet.name, field.name);
                        let fieldTypeDropdownEleFiller = fieldTypeDropdownEle.cloneNode(true);
                        fieldTypeDropdownEle.classList.add("floater");
                        fieldEle.appendChild(fieldTypeDropdownEle);

                        fieldTypeDropdownEleFiller.classList.add("spacefiller");
                        fieldEle.appendChild(fieldTypeDropdownEleFiller);

                        if (selectedField == fieldText) {
                            fieldEle.classList.add("highlightedfield");
                        }
                    });
                });
            }

            const DROPDOWNOPTIONS = [ "", "S", "B" ];

            function getDropdownElement(facetName, fieldName) {
                let dropdown = document.createElement("select");
                dropdown.dataset.facet = facetName;
                dropdown.dataset.field = fieldName;
                dropdown.onchange = selectFieldType;

                DROPDOWNOPTIONS.forEach(value => {
                    let dropdownEle = document.createElement("option");
                    if (value === getFacetFieldByNames(facetName, fieldName).type) { dropdownEle.selected = true; }
                    dropdownEle.innerText = value;
                    dropdown.appendChild(dropdownEle);
                });

                return dropdown;
            }

            function selectFieldType() {
                const facetName = this.dataset.facet, fieldName = this.dataset.field;
                const typeValue = this.value;

                let field = getFacetFieldByNames(facetName, fieldName);
                field.type = typeValue;
                checkSavedState();
            }

            function getFacetByName(name) {
                return APP_STATE.facets[APP_STATE.facets.findIndex(facet => facet.name == name)];
            }

            function getFacetFieldByNames(facetName, fieldName) {
                let facet = getFacetByName(facetName);
                let field = facet.fields[facet.fields.findIndex(field => field.name == fieldName)];
                return field;
            }

            function addFacet() {
                const name = prompt("Please provide a new, unique facet name")?.trim();
                if (!name) { return; }

                if (APP_STATE.facets.map(o => o.name).includes(name)) {
                    alert("This name already exists, please choose another");
                    return;
                }
                
                APP_STATE.facets.push(getNewFacet(name));
                APP_STATE.facets = APP_STATE.facets.sort((a, b) => sortComparator(a.name, b.name));
                redrawPage();

                console.debug("ADDFACET: New facet added:", name);
            }

            function getNewFacet(name) { return { name, fields: [] }; }

            function addField() {
                if (!selectedFacet) { alert("Please select a facet first"); return; }

                const facet = getFacetByName(selectedFacet);
                const name = prompt("Please provide a new field name")?.trim();
                if (!name) { return; }
                if (facet?.fields?.map(field => field.name).includes?.(name)) { alert("Facet already contains this field"); return; }
                if (!Array.isArray(facet?.fields)) { facet.fields = []; }
                facet.fields.push(getNewField(name));

                facet.fields = facet.fields.sort((a, b) => sortComparator(a.name, b.name));
                
                redrawPage();
            }

            function getNewField(name) { return { name, type: "" } };

            function sortComparator(a, b) {
                const aLower = a?.toLowerCase(), bLower = b?.toLowerCase();
                return aLower == bLower ? a > b : aLower > bLower;
            }

            function selectFacet() {
                selectedFacet = this.innerText;
                selectedField = undefined;
                redrawPage();
            }

            function editFacetName() {
                if (!selectedFacet) { return; }
                console.debug(`EDITFACET: Editing facet name from ${selectedFacet}`);

                const name = prompt("Please provide a new, unique facet name")?.trim();
                if (!name) { return; }

                if (APP_STATE.facets.map(o => o.name).includes(name)) {
                    alert("This name already exists, please choose another");
                    return;
                }
                
                const oldFacetName = selectedFacet;
                let facet = getFacetByName(oldFacetName);
                facet.name = name;
                selectedFacet = name;
                redrawPage();

                console.debug(`EDITFACET: Facet name updated from ${oldFacetName} to ${name}`);
            }

            function editFieldName() {
                if (!selectedFacet || !selectedField) { return; }
                console.debug(`EDITFIELD: Editing facet and field name from ${selectedFacet}.${selectedField}`);

                const name = prompt("Please provide a new field name")?.trim();
                let facet = getFacetByName(selectedFacet);
                if (!name ) { return; }
                if (facet?.fields?.includes?.(name)) { alert("Facet already contains this field"); return; }

                let index  = facet.fields.findIndex(field => field == selectField);
                facet.fields = facet.fields.filter(field => field !== selectedField);
                facet.fields.push(name);

                const oldFieldName = selectedField;
                selectedField = name;
                redrawPage();
                
                console.debug(`EDITFACET: Field name updated from ${selectedFacet}.${oldFieldName} to ${selectedFacet}.${name}`);
            }

            function deleteFacet() {
                if (!selectedFacet) { return; }
                if (!confirm(`Are you SURE you want to delete facet ${selectedFacet}?`)) { return; }

                const name = selectedFacet;
                const oldCount = APP_STATE.facets.length;
                APP_STATE.facets = APP_STATE.facets.filter(facet => facet.name !== selectedFacet);
                const newCount = APP_STATE.facets.length;
                selectedFacet = undefined;
                redrawPage();

                console.warn(`DELETEFACET: Removed a facet: ${name}. Old count=[${oldCount}], new count=[${newCount}]`);
            }

            function deleteField() {
                if (!selectedFacet || !selectField) { return; }
                if (!confirm(`Are you SURE you want to delete field ${selectedFacet}.${selectedField}?`)) { return; }

                let facet = getFacetByName(selectedFacet);
                let name = selectedField;
                const oldCount = facet.fields.length;
                facet.fields = facet.fields.filter(field => field.name !== selectedField);
                const newCount = facet.fields.length;
                redrawPage();

                console.warn(`DELETEFIELD: Removed a field: ${selectedField}.${name}. Old count=[${oldCount}], new count=[${newCount}]`);
            }

            function selectField() {
                selectedField = this.innerText;
                redrawPage();
            }

            function saveAppState() {
                console.debug("SAVEAPP: Saving application state");
                const validatedState = getValidatedState(APP_STATE);
                const dataAsString = JSON.stringify(validatedState);
                window.localStorage.setItem(CONSTS.LSKEY, dataAsString);
                APP_STATE_SAVED = clone(validatedState);
                redrawPage();
                console.log(`SAVEAPP: Data saved to localStorage key=[${CONSTS.LSKEY}]`);
            }

            // Do some data shuffling/validating on object structure
            function getValidatedState(state) {
                let newState = clone(state);
                newState.facets.forEach(facet => {
                    facet.fields = facet.fields
                        .map(field => {
                            if (typeof field === "object") { return field; }
                            if (typeof field === "string") {
                                return {
                                    name: field,
                                    type: "",
                                };
                            }
                            
                            return field;
                        })
                        .sort((a, b) => sortComparator(a.name, b.name));
                });

                newState.facets = newState.facets.sort((a, b) => sortComparator(a.name, b.name));

                return newState;
            }
            
            function loadFromOrbit() {
                console.warn("LOADROMORBIT: Confirming user is crazy");
                if (!confirm("Are you sure you want to load all of app state?")) { return; }
                let newAppState;
                if (!(newAppState = prompt("Please specify the entire app state").trim())) { return; }
                
                console.warn("LOADROMORBIT: Loading from orbit, hold on to something");
                window.localStorage.setItem(CONSTS.LSKEY, newAppState);
                console.warn("LOADROMORBIT: Target is loaded");
                location.reload();
            }

            function nukeFromOrbit() {
                console.warn("NUKEFROMORBIT: Confirming user is crazy");
                if (!confirm("Are you sure you want to delete all of app state?")) { return; }
                
                console.warn("NUKEFROMORBIT: Nuking from orbit, hold on to your butts");
                window.localStorage.removeItem(CONSTS.LSKEY);
                console.warn("NUKEFROMORBIT: Target is cleared");
                location.reload();
            }

            function logState() {
                console.log("Saved state:", JSON.stringify(APP_STATE_SAVED));
                console.log("Current state:", JSON.stringify(APP_STATE));
            }

            function loadAppState() {
                console.debug("LOADAPP: Loading application from local storage")
                const data = window.localStorage.getItem(CONSTS.LSKEY);
                APP_STATE = JSON.parse(data) ?? getDefaultAppState();
                APP_STATE_SAVED = clone(APP_STATE);
                console.debug(`LOADAPP: Application loaded from state, facets loaded: ${APP_STATE?.facets?.length ?? 0}`)
            }

            function getDefaultAppState() { return { facets: [] }; };

            function toggleUnsavedData() {
                const isVisible = !document.getElementById("#unsaved").classList.contains("hidden");
                if (isVisible) {
                    document.getElementById("#unsaved").classList.push("hidden");
                } else {
                    document.getElementById("#unsaved").classList.remove("hidden");
                }
            }

            function setSavedFlag(isSaved) {
                const isVisible = !document.getElementById("unsaved").classList.contains("hidden");
                if (isSaved && isVisible) {
                    document.getElementById("unsaved").classList.add("hidden");
                } else if (!isSaved && !isVisible) {
                    document.getElementById("unsaved").classList.remove("hidden");
                }
            }

            function processKeys(event) {
                // Deselect facet
                if (event.key === "Escape") {
                    selectedFacet = null;
                    selectedField = null;
                    redrawPage();
                };
            }
        </script>
    </head>
    <body onkeydown="processKeys(event);" onload="preparePage();">
        <div class="action-bar">
            <button id="saveState">Save</button>
            <button id="loadFromOrbit">Load</button>
            <button id="nukeFromOrbit">Nuke State</button>
            <button id="logState">Log State</button>
            <div class="hidden" id="unsaved">
                <br>
                <label>Unsaved data</label>
            </div>
        </div>
        <div class="tableContent">
            <div class="facets">
                <h2>Facets</h2>
                <button id="addFacet" value="Add">Add</button>
                <button disabled id="editFacetName" value="Edit">Edit</button>
                <button disabled id="deleteFacet" value="Edit">Delete</button>
                <ol id="facetList">
                </ol>
            </div>
            <div class="fields">
                <h2>Fields</h2>
                <button id="addField" value="Add">Add</button>
                <button disabled id="editFieldName" value="Edit">Edit</button>
                <button disabled id="deleteField" value="Delete">Delete</button>
                <ol id="fieldList">
                </ol>
            </div>
            <div></div>
        </div>
    </body>
</html>